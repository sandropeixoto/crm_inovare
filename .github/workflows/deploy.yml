name: üöÄ Deploy Autom√°tico para AWS EC2

on:
  push:
    branches:
      - main   # dispara o deploy sempre que houver push na branch main

jobs:
  deploy:
    name: Publicar c√≥digo no servidor AWS
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Faz o checkout do c√≥digo no ambiente do GitHub Actions
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Faz upload dos arquivos modificados para o servidor AWS via SSH
      - name: Upload de arquivos para a inst√¢ncia EC2
        uses: easingthemes/ssh-deploy@v4
        with:
          ssh-private-key: ${{ secrets.AWS_SSH_KEY }}       # chave privada PEM (configurada em Secrets)
          remote-user: ${{ secrets.AWS_USER }}              # geralmente 'ubuntu' ou 'ec2-user'
          server-ip: ${{ secrets.AWS_SERVER_IP }}           # IP p√∫blico da inst√¢ncia
          remote-path: /var/www/html/crm_inovare            # diret√≥rio destino no servidor
          local-path: ./                                   # envia tudo a partir da raiz do repo
          exclude: |                                       # ignora arquivos desnecess√°rios
            .git*
            .github*
            .env
            node_modules/
            vendor/
            storage/
            tmp/
            cache/
            logs/
            *.log
            *.zip
            *.tar
            *.gz

      # 3Ô∏è‚É£ Reinicia o Apache ou Nginx ap√≥s o deploy
      - name: Reiniciar servidor web
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.AWS_SERVER_IP }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            echo "üîÑ Reiniciando servidor web..."
            if command -v apache2 > /dev/null; then
              sudo systemctl restart apache2
              echo "‚úÖ Apache reiniciado"
            elif command -v httpd > /dev/null; then
              sudo systemctl restart httpd
              echo "‚úÖ HTTPD reiniciado"
            elif command -v nginx > /dev/null; then
              sudo systemctl restart nginx
              echo "‚úÖ Nginx reiniciado"
            else
              echo "‚ö†Ô∏è Nenhum servidor web detectado!"
            fi

      # 4Ô∏è‚É£ (Opcional) Exibe mensagem de conclus√£o no log do GitHub Actions
      - name: Finaliza√ß√£o
        run: echo "üéâ Deploy conclu√≠do com sucesso em ${{ secrets.AWS_SERVER_IP }}"
